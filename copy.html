<section class="checkout_area section_gap">
  <?php
    foreach ($PedidosLista as $cadpedido) {
    ?>
  <div class="container">
    <div class="billing_details">
      <div class="row">
        <div class="col-lg-6">
          <div class="order_box">
            <h2>INFORMACIÓN DE TU PEDIDO</h2>
            <ul class="list list_2">
              <li>
                <p>Número de Pedido</p><span>:
                  <?php echo $cadpedido['id']; ?>
                </span>
              </li>
            </ul>
            <ul class="list list_2">
              <li>
                <p>Fecha del Pedido</p><span>:
                  <?php echo $cadpedido['pedidoFecha']; ?>
                </span>
              </li>
              <li>
                <p>Total</p><span>:
                  <?php echo $cadpedido['pagoTotal']; ?>
                </span>
              </li>
            </ul>
          </div>
          <div class="">
            <span>Gracias por ordenar. Tu pedido ha sido recibido.</span>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="order_box">
            <h2>TU ORDEN</h2>
            <table class="table table-borderless">
              <thead>
                <tr>
                  <th scope="col" colspan="2">Producto</th>
                  <th scope="col">Cantidad</th>
                  <th scope="col">Total</th>
                </tr>
              </thead>
              <?php
                  $PedidosQuery = $pdo->prepare("SELECT id, pedidoFecha, clienteNombre, productoNombre,
                  productoQTY, productoPrecio, pagoTotal 
                    FROM pedidodetalles INNER JOIN pedidos USING (id) INNER JOIN productos USING 
                    (id) INNER JOIN cliente USING (id)
                    WHERE id = :id AND id = :id  ORDER BY pedidoFecha DESC;");
                  $PedidosQuery->bindParam(':id', $_SESSION['session_clienteID']);
                  $PedidosQuery->bindParam(':id', $cadpedido['id']);
                  $PedidosQuery->execute();
                  $ListadoPedido = $PedidosQuery->fetchAll(PDO::FETCH_ASSOC);
                  foreach ($ListadoPedido as $dpedido) {
                  ?>
              <tbody>
                <tr>
                  <th colspan="2"><span>
                      <?php echo $dpedido['productoNombre']; ?>
                    </span></th>
                  <th>
                    <?php echo $dpedido['productoQTY']; ?>
                  </th>
                  <th> <span>$
                      <?php echo $dpedido['productoPrecio']; ?>
                    </span></th>
                </tr>
              </tbody>
              <?php } ?>
              <tfoot>
                <tr>
                  <th scope="col" colspan="3"></th>
                  <th scope="col">Total :
                    <?php echo $cadpedido['pagoTotal']; ?>
                  </th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <?php } ?>
</section>





  <section class="py-5">
    <?php if (!empty($_SESSION['CARRITO'])) { ?>
    <div class="row">
      <div class="col-lg-12 mb-4 mb-lg-0">
        <!-- CART TABLE-->
        <form class="col-md-12" method="post">
          <div class="table-responsive mb-4">
            <table class="table text-nowrap">
              <thead class="bg-light">
                <tr>
                  <th class="border-0 p-3" scope="col"> <strong class="text-sm text-uppercase">Producto</strong></th>
                  <th class="border-0 p-3" scope="col"> <strong class="text-sm text-uppercase">Precio</strong></th>
                  <th class="border-0 p-3" scope="col"> <strong class="text-sm text-uppercase">Cantidad</strong></th>
                  <th class="border-0 p-3" scope="col"> <strong class="text-sm text-uppercase">Total</strong></th>
                  <th class="border-0 p-3" scope="col"> <strong class="text-sm text-uppercase"></strong></th>
                </tr>
              </thead>
              <tbody class="border-0">
                <?php $total = 0; ?>
  
                <?php foreach ($_SESSION['CARRITO'] as $indice => $producto) { ?>
  
                <tr>
                  <th class="ps-0 py-3 border-light" scope="row">
                    <div class="d-flex align-items-center">
                      <img src="<?php echo 'admin/assets/images/' . $producto['IMAGEN'] ?>" alt="..." width="70" />
                      <div class="ms-3">
                        <?php echo $producto['NOMBRE'] ?>
                      </div>
                    </div>
                  </th>
                  <td class="price-pr">
                    <p id="price">$
                      <?php echo $producto['PRECIO'] ?>
                    </p>
                  </td>
                  <td>
                    <div class="product_count" id="<?php echo $indice; ?>">
                      <span class="input-number-decrement"> <i class="ti-minus"></i></span>
                      <input class="" type="number" id="quantity" value="<?php echo $producto['CANTIDAD'] ?>" min="0"
                        max="10">
                      <span class="input-number-increment"> <i class="ti-plus"></i></span>
                    </div>
                  </td>
                  <td class="total-pr">
                    <p id="total">$
                      <?php echo number_format(intval($producto['PRECIO']) * intval($producto['CANTIDAD']), 2); ?>
                    </p>
                  </td>
                  <td class="p-3 align-middle border-light">
                    <form action="cart.php" method="post">
                      <input type="hidden" name="id" id="id"
                        value="<?php echo openssl_encrypt($producto['ID'], COD, KEY); ?>">
                      <button class="btn btn-danger" name="action" value="Eliminar">Eliminar</button>
                    </form>
                  </td>
                </tr>
                <?php
                      $total = $total + (floatval($producto['PRECIO']) * intval($producto['CANTIDAD'])); ?>
                <?php } ?>
              </tbody>
            </table>
            <?php
                if (isset($_SESSION["session_username"])) { //we check if the session username variable has infromation
                  //if it does we display a button that says FINALIZAR PEDIDO,
                  //it will be executed the form action pedir.php code so the order goes to the database
                  echo '<form action="checkout.php" method="post">
                  <input type="hidden" name="help" id="help" value="">
                  <div class="bg-light px-4 py-3">
                  <div class="row align-items-center text-center">
                    <div class="col-md-6 mb-3 mb-md-0 text-md-start">
                      <a class="btn btn-warning btn-lg" href="shop.php">
                        <i class="fas fa-long-arrow-alt-left me-2"> </i>Continuar buscando</a>
                      </div>
                    <div class="col-md-6 text-md-end">
                      <button class="btn btn-success btn-lg" type="submit" name="action" value="proceder" href="checkout.php">Proceder al pedido<i class="fas fa-long-arrow-alt-right ms-2"></i></button>
                    </div>
                  </div>
                </div>
                  </form>';
                } else {
                  //but if user is not logged it, we take him to the loggin page using another form action
                  //the button looks the same but we redirect the user to loggin page instead 
                  echo '<form action="login.php" method="post">
                  <div class="bg-light px-4 py-3">
                  <div class="row align-items-center text-center">
                    <div class="col-md-6 mb-3 mb-md-0 text-md-start"><a class="btn btn-success btn-lg" href="shop.php"><i class="fas fa-long-arrow-alt-left me-2"> </i>Continuar buscando</a></div>
                    <div class="col-md-6 text-md-end"><button class="btn btn-warning btn-lg" type="submit" name="action" value="proceder" href="checkout.php">Proceder al pedido<i class="fas fa-long-arrow-alt-right ms-2"></i></button></div>
                  </div>
                </div>
                  </form>';
                }
  
                ?>
          </div>
        <!-- ORDER TOTAL-->
        <div class="col-lg-4 col-sm-12">
          <div class="card border-0 rounded-0 p-lg-4 bg-light">
            <div class="card-body">
              <h5 class="text-uppercase mb-4">Total del carrito</h5>
              <ul class="list-unstyled mb-0" id="">
                <li class="border-bottom my-2"></li>
                <li class="d-flex align-items-center justify-content-between mb-4"><strong
                    class="text-uppercase small font-weight-bold">Total</strong>
                  <div id="precioTotal">$
                    <?php echo number_format($total, 2); ?>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <br>
        <!-- CART NAV-->
  
      </div>
  
    </div>
    <?php } else { ?>
    <div class="alert alert-success">
      No hay productos en el carrito..
    </div>
    <?php } ?>
  </section>



  <?php foreach ($ListProducto as $producto) : ?>
                <div class="col-lg-4 col-md-6">
                  <div class="single-product">
                    <div class="product-img">
                      <img class="card-img" src="<?php echo 'admin/assets/images/' . $producto['productoImg']; ?>" alt="...">
                      <div class="p_icon">
                        <form action="" method="post">
                          <button type="submit" name="action" value="Agregar" class="btn btn-success">
                            <i class="ti-shopping-cart fa-1x mr-2"></i>
                            Agregar
                          </button>
                      </div>
                    </div>
                    <div class="product-btm text-center">
                      <h4 class="reset-anchor">
                        <?php echo $producto['productoNombre']; ?>
                      </h4>
                      <span>$
                        <?php echo $producto['productoPrecio']; ?>
                      </span>
                        <input type="hidden" name="id" id="id" value="<?php echo openssl_encrypt($producto['id'], COD, KEY); ?>">
                        <input type="hidden" name="nombre" id="nombre" value="<?php echo openssl_encrypt($producto['productoNombre'], COD, KEY); ?>">
                        <input type="hidden" name="precio" id="precio" value="<?php echo openssl_encrypt($producto['productoPrecio'], COD, KEY); ?>">
                        <input type="hidden" name="imagen" id="imagen" value="<?php echo openssl_encrypt($producto['productoImg'], COD, KEY); ?>">
                        <input type="hidden" name="cantidad" id="cantidad" value="<?php echo openssl_encrypt(1, COD, KEY); ?>">
                        <div class="d-flex justify-content-center align-items-center">
                          <i class="fa-solid fa-boxes-stacked fa-2x mr-2"></i>
                          <div class="mr-2">
                            <?php if ($producto['productoQTY'] <= 0) : ?>
                              <span class="badge badge-danger">Agotado</span>
                            <?php else : ?>
                              <span class="badge badge-success">
                                <?php echo $producto['productoQTY']; ?>
                              </span>
                            <?php endif; ?>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              <?php endforeach; ?>

              <div class="checkout_btn_inner">
                        <?php
                        if (isset($_SESSION["user"])) {
                          echo '<form action="checkout.php" method="post">
                  <input type="hidden" name="help" id="help" value="">
                  <div class="bg-light px-4 py-3">
                  <div class="row align-items-center text-center">
                    <div class="col-md-6 mb-3 mb-md-0 text-md-start">
                      <a class="main_btn" href="shop.php">
                        <i class="fas fa-long-arrow-alt-left me-2"> </i> Continuar buscando</a>
                      </div>
                    <div class="col-md-6 text-md-end">
                      <button class="main_btn" type="submit" name="Accion" value="proceder" href="checkout.php"> Proceder al pedido <i class="fas fa-long-arrow-alt-right ms-2"></i></button>
                    </div>
                  </div>
                </div>
                  </form>';
                        } else {
                          echo '<form action="login.php" method="post">
                  <div class="bg-light px-4 py-3">
                  <div class="row align-items-center text-center">
                    <div class="col-md-6 mb-3 mb-md-0 text-md-start"><a class="main_btn" href="shop.php">
                    <i class="fas fa-long-arrow-alt-left me-2"> </i> Continuar buscando</a>
                    </div>
                    <div class="col-md-6 text-md-end"><button class="main_btn" type="submit" name="Accion" value="proceder" href="checkout.php"> Proceder al pedido <i class="fas fa-long-arrow-alt-right ms-2"></i></button></div>
                  </div>
                </div>
                  </form>';
                        }
                        ?>
                      </div>


                      <div class="modal fade" id="productInfoModal" tabindex="-1" role="dialog" aria-labelledby="productInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title" id="productInfoModalLabel"><?php echo $producto['productoNombre']; ?></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-6">
                        <img class="img-fluid" src="<?php echo 'admin/assets/images/' . $producto['productoImg']; ?>" alt="...">
                    </div>
                    <div class="col-6">
                        <p><?php echo $producto['productoDetalles']; ?></p>
                        <p>Precio: $<?php echo $producto['productoPrecio']; ?></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
      const quantities = document.querySelectorAll("#quantity");
      const prices = document.querySelectorAll("#total");

      document.addEventListener("DOMContentLoaded", () => {
        quantities.forEach(quantity => {
          quantity.value = 1;
          actualizarValue();
        });
      });

      quantities.forEach(quantity => {
        quantity.addEventListener("change", () => {
          //Poner precios dinamicos
          const price = quantity.parentElement.parentElement.parentElement.querySelector("#price");
          const total = quantity.parentElement.parentElement.parentElement.querySelector("#total");
          const id = quantity.parentElement.id;
          total.textContent = "$ " + (quantity.value) * (price.textContent.replace("$ ", "").replace(".00", "")) + ".00";

          //Intento de actualizar
          actualizarValue();
          actualizarTotal();
        })
      });

      function actualizarTotal() {
        let total = 0;
        const precioTotal = document.querySelector("#precioTotal");
        prices.forEach(price => {
          total += parseInt(price.textContent.replace("$ ", ""));
        });
        precioTotal.textContent = "$" + total + ".00";
      }

      function actualizarValue() {
        const help = document.querySelector("#help");
        help.value = "";
        document.querySelectorAll("#quantity").forEach(element => {
          const id = element.parentElement.id;
          help.value += id + "-" + element.value + "/";
        });
      }
    </script>

        <script>
          function confirmacion() {
            var respuesta = confirm("¿Está seguro que quiere eliminar este registro?");
            if (respuesta == true) {
              return true;
            } else {
              return false;
            }
          }
        </script>
DELIMITER //
CREATE PROCEDURE ModifyProduct (
  IN ProductoID INT,
  IN Productoname VARCHAR(255),
  IN Productoprice DECIMAL(10,2),
  IN Productodetails TEXT,
  IN Productoqty INT,
  IN Productoimg VARCHAR(255),
  IN CategoriaID INT
)
BEGIN
  UPDATE productos SET productoNombre = Productoname, productoPrecio = Productoprice, productoDetalles = Productodetails,
    productoQTY = Productoqty, productoImg = Productoimg, categoriaID = CategoriaID
  WHERE id = ProductoID;
END //
DELIMITER ;

DELIMITER //
CREATE PROCEDURE AddProduct (
  IN Productoname VARCHAR(255),
  IN Productoprice DECIMAL(10,2),
  IN Productodetails TEXT,
  IN Productoqty INT,
  IN Productoimg VARCHAR(255),
  IN CategoriaID INT
)
BEGIN
  INSERT INTO productos (productoNombre, productoPrecio, productoDetalles, productoQTY, productoImg, categoriaID)
  VALUES (Productoname, Productoprice, Productodetails, Productoqty, Productoimg, CategoriaID);
END //
DELIMITER ;

<?php
  $QueryPedidos = $pdo->prepare("SELECT id, pedidoFecha, pagoTotal , estadoID, clienteID FROM pedidos
    Where idCliente = :id ORDER BY fechaPedido DESC");
  $QueryPedidos->bindParam(':id', $_SESSION['session_clienteID']);
  $QueryPedidos->execute();
  $PedidosLista = $QueryPedidos->fetchAll(PDO::FETCH_ASSOC);
  $Pedido = $QueryPedidos->fetch(PDO::FETCH_LAZY);
  ?>
<section class="checkout_area section_gap">
  <?php 
      foreach($PedidosLista as $cadpedido){
      ?>